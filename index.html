<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quiz Ù…Ø­Ù„ÙŠ â€” English â†’ Arabic (App)</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2563eb">
  <style>
    :root{--accent:#2563eb;--ok:#16a34a;--bad:#dc2626}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;display:flex;align-items:center;justify-content:center;min-height:100vh;background:#f3f4f6;margin:0;padding:18px}
    .app{width:420px;max-width:96vw;background:white;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.08);overflow:hidden}
    header{padding:14px;border-bottom:1px solid #eef2ff;background:linear-gradient(90deg,#eef2ff, #ffffff);}
    h1{margin:0;font-size:17px;color:#0f172a}
    .content{padding:14px}
    textarea{width:100%;height:110px;padding:10px;border:1px solid #e6edf6;border-radius:8px;resize:vertical;direction:ltr}
    .row{display:flex;gap:8px;margin-top:10px}
    button{flex:1;padding:10px;border-radius:8px;border:0;background:var(--accent);color:white;font-weight:600;cursor:pointer}
    button.secondary{background:#e6eefc;color:var(--accent);border:1px solid #cfe0ff}
    .quiz{display:none;gap:12px;flex-direction:column;align-items:center}
    .face{font-size:64px}
    .eng{font-size:28px;font-weight:700;margin:6px 0}
    .options{width:100%;display:flex;flex-direction:column;gap:8px}
    .opt{padding:12px;border-radius:8px;border:1px solid #e6edf6;background:#fff;text-align:right;cursor:pointer;color:#0f172a}
    .opt.correct{border-color:var(--ok);background:rgba(16,185,129,0.12);color:#064e3b}
    .opt.wrong{border-color:var(--bad);background:rgba(220,38,38,0.06);color:#7f1d1d}
    .meta{display:flex;justify-content:space-between;align-items:center;margin-top:10px;font-size:14px;color:#334155}
    .small{font-size:13px;color:#64748b}
    footer{padding:10px;text-align:center;border-top:1px solid #eef2ff;background:#fbfdff}
    .hint{font-size:13px;color:#475569}
    input[type="text"]{width:100%;padding:8px;border-radius:8px;border:1px solid #e6edf6}
    .controls{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Quiz Ù…Ø­Ù„ÙŠ â€” Ø­ÙØ¸ ÙˆØ¯Ù…Ø¬ Ø§Ù„ÙƒÙ„Ù…Ø§Øª</h1>
    </header>
    <div class="content">
      <div id="setup">
        <p class="small">Ø£Ù„ØµÙ‚ ÙƒÙ„Ù…Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø£ÙŠ Ù…Ù† Ø§Ù„ØµÙŠØº Ø§Ù„ØªØ§Ù„ÙŠØ© (Ù…Ø«Ø§Ù„Ø§Ù†):</p>
        <pre style="background:#f8fafc;padding:8px;border-radius:6px;border:1px solid #eef2ff;direction:ltr">Book=ÙƒØªØ§Ø¨ She=Ù‡ÙŠ Red=Ø£Ø­Ù…Ø± House=Ø¨ÙŠØª Water=Ù…Ø§Ø¡
Ø£Ùˆ ÙƒÙ„ Ø³Ø·Ø±: Book=ÙƒØªØ§Ø¨
She=Ù‡ÙŠ
Red=Ø£Ø­Ù…Ø±</pre>
        <textarea id="pairs" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ù‡Ù†Ø§ â€” Ù…Ø³Ø§ÙØ§Øª Ø£Ùˆ Ø£Ø³Ø·Ø± Ø£Ùˆ ÙÙˆØ§ØµÙ„ Ù…Ù‚Ø¨ÙˆÙ„Ø©"></textarea>

        <div class="controls">
          <button id="merge">Ø£Ø¶Ù/Ø§Ø¯Ù…Ø¬ Ø§Ù„ÙƒÙ„Ù…Ø§Øª (Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ)</button>
          <button id="start" class="secondary">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
          <button id="clearAll" class="secondary">Ø­Ø°Ù ÙƒÙ„ Ø§Ù„ÙƒÙ„Ù…Ø§Øª</button>
        </div>

        <div class="controls">
          <button id="show" class="secondary">Ø¹Ø±Ø¶ Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª</button>
          <button id="export" class="secondary">ØªØµØ¯ÙŠØ± (Ù†Ø³Ø® Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©)</button>
        </div>

        <p class="hint">Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ù‚ÙˆØ§Ø¦Ù… Ø¬Ø¯ÙŠØ¯Ø© ØªÙØ¯Ù…Ø¬ Ø§Ù„ÙƒÙ„Ù…Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ â€” Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙƒØ±Ù‘Ø±Ø© ØªÙØ­Ø°Ù Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© (ØºÙŠØ± Ø­Ø³Ø§Ø³Ø© Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø­Ø±Ù). Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª ØªØ­Ø¯ÙŠØ« ØªØ±Ø¬Ù…Ø© ÙƒÙ„Ù…Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ø£Ø¶ÙÙ‡Ø§ Ø¨ØµÙŠØºØ© Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©.</p>
      </div>

      <div id="quiz" class="quiz">
        <div class="face">ğŸ™‚</div>
        <div class="eng" id="english">WORD</div>
        <div class="options" id="options"></div>
        <div class="meta">
          <div class="small">Ø§Ù„Ø³Ø¤Ø§Ù„ <span id="index">0</span>/<span id="total">0</span></div>
          <div class="small">Ø¯Ø±Ø¬Ø©: <span class="score" id="score">0</span></div>
        </div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="next" class="secondary">Ø§Ù„ØªØ§Ù„ÙŠ</button>
          <button id="back" class="secondary">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª</button>
        </div>
      </div>

    </div>
    <footer>
      <div class="small">Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ. Ø§Ù„Ù†Ø³Ø®Ø© Ù‡Ø°Ù‡ ØªØ¹Ù…Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ù„Ø§ Ø§ØªØµØ§Ù„.</div>
    </footer>
  </div>

<script>
// Register service worker for offline/PWA behavior
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('service-worker.js').catch(function(err){ console.log('SW register failed', err); });
  });
}

(function(){
  const STORAGE_KEY = 'english_ar_pairs_v2';
  const pairsInput = document.getElementById('pairs');
  const mergeBtn = document.getElementById('merge');
  const startBtn = document.getElementById('start');
  const showBtn = document.getElementById('show');
  const exportBtn = document.getElementById('export');
  const clearAllBtn = document.getElementById('clearAll');
  const quizEl = document.getElementById('quiz');
  const setupEl = document.getElementById('setup');
  const englishEl = document.getElementById('english');
  const optionsEl = document.getElementById('options');
  const indexEl = document.getElementById('index');
  const totalEl = document.getElementById('total');
  const scoreEl = document.getElementById('score');
  const nextBtn = document.getElementById('next');
  const backBtn = document.getElementById('back');

  let pairs = []; // array of {en, ar}
  let order = [];
  let cur = 0;
  let score = 0;
  let answered = false;
  let autoAdvanceDelay = 700; // ms

  function loadFromStorage(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return [];
      const parsed = JSON.parse(raw);
      if(Array.isArray(parsed)) return parsed;
      return [];
    }catch(e){ return []; }
  }

  function saveToStorage(list){
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); return true; }
    catch(e){ return false; }
  }

  // Parse input flexibly:
  function parseInput(text){
    if(!text) return [];
    let t = text.replace(/[Ø›;]/g, '\\n').replace(/[ï¼Œ,]+/g, '\\n');
    t = t.trim();
    let tokens = [];
    if(t.includes('\\n')) tokens = t.split(/\\n+/).map(s=>s.trim()).filter(Boolean);
    else tokens = t.split(/\\s+/).map(s=>s.trim()).filter(Boolean);
    const out = [];
    for(const token of tokens){
      const parts = token.split(/=|:|,/).map(p=>p.trim()).filter(Boolean);
      if(parts.length>=2){
        for(let i=0;i+1<parts.length;i+=2){
          const en = parts[i];
          const ar = parts[i+1];
          out.push({en: en, ar: ar});
        }
      }
    }
    return out;
  }

  function normalizeEn(en){ return en.trim().toLowerCase(); }

  function mergeWithStorage(newList){
    const stored = loadFromStorage();
    const map = new Map();
    for(const p of stored){ map.set(normalizeEn(p.en), {en:p.en, ar:p.ar}); }
    let added=0, updated=0;
    for(const p of newList){
      const key = normalizeEn(p.en);
      if(map.has(key)){
        const existing = map.get(key);
        if(existing.ar !== p.ar){
          map.set(key, {en: p.en, ar: p.ar});
          updated++;
        }
      } else {
        map.set(key, {en: p.en, ar: p.ar});
        added++;
      }
    }
    const result = Array.from(map.values());
    saveToStorage(result);
    return {added, updated, total: result.length};
  }

  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a }

  function buildOrder(){ pairs = loadFromStorage(); order = pairs.map((p,i)=>i); shuffle(order); cur=0; score=0; updateScore(); }

  function updateScore(){ scoreEl.textContent = score; }

  function renderCard(){
    if(order.length===0){
      alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©. Ø£Ø¶Ù ÙƒÙ„Ù…Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.'); setupEl.style.display='block'; quizEl.style.display='none'; return;
    }
    const idx = order[cur];
    const item = pairs[idx];
    englishEl.textContent = item.en;
    indexEl.textContent = cur+1; totalEl.textContent = order.length;
    answered=false;

    const others = pairs.map(p=>p.ar).filter((a,i)=>i!==idx);
    let choices = [item.ar];
    shuffle(others);
    for(let i=0;i<2;i++){ if(others[i]) choices.push(others[i]); }
    while(choices.length<3){ choices.push(item.ar + Math.random().toString(36).slice(2,4)); }
    choices = shuffle(choices.slice());

    optionsEl.innerHTML = '';
    choices.forEach((text,i)=>{
      const btn = document.createElement('button');
      btn.className='opt'; btn.type='button'; btn.innerText = text || '';
      btn.addEventListener('click',()=> selectOption(btn, text, item.ar));
      optionsEl.appendChild(btn);
    });
  }

  function finishTest(){
    alert('Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±. Ù†ØªÙŠØ¬ØªÙƒ: ' + score + ' Ù…Ù† ' + order.length);
    setupEl.style.display='block'; quizEl.style.display='none';
  }

  function goNextOrFinish(){
    cur++;
    if(cur>=order.length){ finishTest(); }
    else { renderCard(); }
  }

  function selectOption(btn, chosen, correct){
    if(answered) return; answered=true;
    const buttons = optionsEl.querySelectorAll('button');
    buttons.forEach(b=>b.disabled=true);
    if(chosen===correct){ btn.classList.add('correct'); score++; updateScore();
      setTimeout(()=>{ goNextOrFinish(); }, autoAdvanceDelay);
    }
    else { btn.classList.add('wrong');
      for(const b of buttons){ if(b.innerText===correct) b.classList.add('correct'); }
    }
  }

  mergeBtn.addEventListener('click', ()=>{
    const newList = parseInput(pairsInput.value);
    if(newList.length===0){ alert('Ù„Ù… ÙŠØªÙ… Ù‚Ø±Ø§Ø¡Ø© Ø£ÙŠ ÙƒÙ„Ù…Ø§Øª. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØµÙŠØºØ©: English=Arabic Ù„ÙƒÙ„ ÙƒÙ„Ù…Ø©.'); return; }
    const res = mergeWithStorage(newList);
    alert('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©: ' + res.added + 'ØŒ Ø§Ù„ØªØ­Ø¯ÙŠØ«: ' + res.updated + 'ØŒ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¢Ù†: ' + res.total + ' ÙƒÙ„Ù…Ø©.');
    pairsInput.value = '';
  });

  showBtn.addEventListener('click', ()=>{
    const stored = loadFromStorage();
    alert('Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©: ' + stored.length + ' ÙƒÙ„Ù…Ø©.');
  });

  exportBtn.addEventListener('click', async ()=>{
    try{
      const stored = loadFromStorage();
      if(stored.length===0){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±.'); return; }
      const text = stored.map(p=>p.en + '=' + p.ar).join('\\n');
      await navigator.clipboard.writeText(text);
      alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©. ÙŠÙ…ÙƒÙ†Ùƒ Ù„ØµÙ‚Ù‡Ø§ ÙÙŠ Ù…Ù„Ù Ø£Ùˆ Ù…ÙƒØ§Ù† Ø¢Ø®Ø±.');
    }catch(e){
      const stored = loadFromStorage();
      const text = stored.map(p=>p.en + '=' + p.ar).join('\\n');
      prompt('Ø§Ù†Ø³Ø® Ø§Ù„Ù†Øµ Ø§Ù„ØªØ§Ù„ÙŠ (Ctrl+C):', text);
    }
  });

  clearAllBtn.addEventListener('click', ()=>{
    if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.')){ localStorage.removeItem(STORAGE_KEY); alert('ØªÙ… Ø§Ù„Ø­Ø°Ù.'); }
  });

  startBtn.addEventListener('click', ()=>{
    const stored = loadFromStorage();
    if(stored.length===0){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©. Ø£Ø¶Ù ÙƒÙ„Ù…Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.'); return; }
    buildOrder(); setupEl.style.display='none'; quizEl.style.display='flex'; renderCard();
  });

  nextBtn.addEventListener('click', ()=>{
    if(order.length===0) return;
    goNextOrFinish();
  });

  backBtn.addEventListener('click', ()=>{
    setupEl.style.display='block'; quizEl.style.display='none';
  });

  window.addEventListener('keydown',(e)=>{
    if(quizEl.style.display!=='flex') return;
    if(['1','2','3'].includes(e.key)){
      const idx = Number(e.key)-1;
      const btn = optionsEl.querySelectorAll('button')[idx]; if(btn) btn.click();
    }
    if(e.key==='ArrowRight') document.getElementById('next').click();
  });
})(); 
</script>
</body>
</html>
